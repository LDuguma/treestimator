<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treestimator: Tree Population Simulator</title>
    <!-- Chart.js for data visualization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <!-- Chart.js Annotation Plugin for vertical line on chart -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF AutoTable plugin for structured tables in PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* General Reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Body Styling */
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as per instructions */
            background: linear-gradient(180deg, #0a6bda 0%, #31bb0f 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: flex-start; /* Align to top */
        }

        /* Landing Page Specific Styles */
        .landing-page {
            display: flex; /* Initially flex to center content */
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* Take full viewport height */
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            width: 90%; /* Fluid width */
            max-width: 800px; /* Max width for larger screens */
            margin: 0 auto; /* Center horizontally */
        }

        .landing-page h1 {
            color: #2E7D32;
            font-size: 4em;
            font-family:Arial, Helvetica, sans-serif;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .landing-page p {
            color: #666;
            font-size: 1.5em;
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            margin-bottom: 20px; /* Adjusted margin */
            line-height: 1.6;
        }

        .landing-page .description { /* New style for description */
            font-size: 1.1em;
            font-family:'Gill Sans MT','Trebuchet MS', sans-serif;
            margin-bottom: 30px;
            max-width: 600px;
        }

        .landing-page .developer-info { /* New style for developer info */
            font-size: 0.9em;
            color: #888;
            margin-top: 20px;
            margin-bottom: 30px; /* Space before button */
        }

        .landing-page .btn {
            padding: 18px 50px;
            font-size: 1.5em;
            font-weight: 700;
            border-radius: 30px;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        .landing-page .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        /* Main App Container */
        .container {
            max-width: 1400px;
            width: 100%; /* Ensure fluid width */
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px; /* Rounded corners */
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            display: none; /* Hidden by default */
        }

        /* Header Styling */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #4CAF50;
        }

        .header h1 {
            color: #2E7D32;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header p {
            color: #666;
            font-size: 1.2em;
        }

        /* New style for the project details row */
        .project-details-row {
            display: flex; /* Make it a flex container */
            flex-wrap: wrap; /* Allow items to wrap to the next line */
            height: 150x;
            justify-content: space-around; /* Distribute items evenly with space around them */
            align-items: center; /* Align items vertically in the center */
            margin-bottom: 40px; /* Add some space below it */
            padding: 25px; /* Keep existing padding */
            border-radius: 5px; /* Keep existing border-radius */
            border: 1px solid #e0e0e0; /* Keep existing border */
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f5e8 100%); /* Keep existing background */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); /* Keep existing shadow */
        }

        .project-details-row h3 {
            width: 100%; /* Make the heading take full width */
            text-align: center; /* Center the heading */
            margin-bottom: 20px;
            color: #2E7D32;
            font-size: 1.3em;
            border-bottom: 0.5px solid #4CAF50;
            padding-bottom: 10px;
        }

        .project-details-row .input-row {
            flex: 1; /* Allow each input-row to grow and shrink */
            min-width: 280px; /* Minimum width for each input row before wrapping */
            margin: 10px 15px; /* Adjust margin for spacing between items */
            justify-content: space-between; /* Ensure label and input are spaced */
        }

        /* Controls Section */
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .control-group {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8f5e8 100%);
            padding: 25px;
            border-radius: 15px; /* Rounded corners */
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
        }

        .control-group:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .control-group h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            font-size: 1.3em;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .input-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .input-row label {
            font-weight: 200;
            color: #555;
            min-width: 120px;
        }

        .input-row input[type="number"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px; /* Rounded corners */
            width: 120px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-row input[type="text"] {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px; /* Rounded corners */
            width: 120px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .input-row input[type="checkbox"] {
            width: 20px;
            height: 20px;
            border-radius: 4px; /* Rounded corners */
            cursor: pointer;
        }

        .input-row input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.2);
        }

        /* Thinning section specific styles */
        .thinning-regime {
            background: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .thinning-regime h4 {
            color: #2E7D32;
            margin-bottom: 10px;
            font-size: 1em;
        }

        .remove-thinning-btn {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8em;
            margin-top: 10px;
        }

        .remove-thinning-btn:hover {
            background: #cc0000;
        }

        .add-thinning-btn {
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .add-thinning-btn:hover {
            background: #45a049;
        }

        /* Button Styling */
        .button-container {
            text-align: center;
            margin: 30px 0;
        }

        .btn {
            padding: 15px 40px;
            font-size: 1.2em;
            font-weight: 600;
            border: none;
            border-radius: 25px; /* Rounded corners */
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); /* Added shadow for all buttons */
        }

        .btn-primary {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
            color: white;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }

        /* Results Section */
        .results {
            display: none; /* Hidden by default */
            margin-top: 40px;
        }

        /* Summary Cards */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .summary-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            border-radius: 15px; /* Rounded corners */
            text-align: center;
            border: 2px solid #e0e0e0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05); /* Added subtle shadow */
        }

        .summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        }

        .summary-card h4 {
            color: #2E7D32;
            font-size: 1.1em;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 1.4em;
            font-weight: 700;
            color: #4CAF50;
            margin-bottom: 5px;
        }

        /* Charts Container */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .chart-wrapper {
            background: white;
            padding: 25px;
            border-radius: 15px; /* Rounded corners */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-height: 450px; /* Added max-height to contain the chart */
            display: flex; /* Use flexbox for centering content */
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .chart-wrapper h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
        }

        /* Canvas specific styling */
        canvas {
            max-width: 100%; /* Ensure canvas doesn't overflow its wrapper */
            max-height: 350px; /* Explicit max-height for the canvas */
            width: 100% !important; /* Override Chart.js inline styles if necessary */
            height: auto !important; /* Maintain aspect ratio within max-height */
        }

        /* Detailed Table */
        .detailed-table {
            background: white;
            border-radius: 15px; /* Rounded corners */
            overflow: hidden; /* For table borders */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .detailed-table h3 {
            background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
            color: white;
            padding: 20px;
            margin: 0;
            font-size: 1.3em;
            text-align: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2E7D32;
        }

        tbody tr:hover {
            background: #f0f0f0; /* Lighter hover effect */
        }

        /* Methodology Section */
        .methodology {
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            padding: 30px;
            border-radius: 15px; /* Rounded corners */
            border-left: 5px solid #4CAF50;
            margin-bottom: 30px;
        }

        .methodology h3 {
            color: #2E7D32;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .methodology p {
            line-height: 1.6;
            color: #555;
            margin-bottom: 15px;
        }

        .methodology ul {
            padding-left: 20px;
            color: #555;
        }

        .methodology li {
            margin-bottom: 10px;
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr; /* Stack charts on smaller screens */
            }
        }

        @media (max-width: 768px) {
            .controls {
                grid-template-columns: 1fr; /* Stack control groups */
            }
            
            .input-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .input-row input[type="number"] {
                width: 100%;
            }

            .btn {
                padding: 12px 25px;
                font-size: 1em;
                margin: 5px; /* Adjust margin for smaller buttons */
            }
            /* Adjustments for smaller screens for project details row */
            .project-details-row {
                flex-direction: column; /* Stack items vertically on small screens */
                align-items: flex-start; /* Align to start when stacked */
            }
            .project-details-row .input-row {
                width: 100%; /* Full width for input rows when stacked */
                margin: 10px 0; /* Adjust margin */
            }
            .landing-page h1 {
                font-size: 2.2em;
            }
            .landing-page p {
                font-size: 1.2em;
            }
            .landing-page .description {
                font-size: 1em;
            }
            .landing-page .developer-info {
                font-size: 0.8em;
            }
            .landing-page .btn {
                font-size: 1.2em;
                padding: 15px 30px;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.8em;
            }
            .header p {
                font-size: 1em;
            }
            .summary-card .value {
                font-size: 1.8em;
            }
        }
    </style>
</head>
<body>
    <!-- Landing Page -->
    <div class="landing-page" id="landingPage">
        <h1>Treestimator <span style="font-size:0.3em; color:#4c8f43; font-family:'Gill Sans MT'; font-weight:normal; vertical-align: text-top; margin-left:8px;">(Beta)</span> 🌱</h1> <br>
        <p>Contextualized Project Level Seedling to <br>Trees  Modeling Tool</p><br>
        <p class="description">
            <em> Treestimator helps you simulate tree populations at different ages, using your estimates for seedling survival and replacement planting strategies, to enable more effective restoration planning. </em>
        </p>
        <p class="developer-info">
            Developed by Lalisa Duguma, PhD <br> Global Evergreening Alliance (GEA)
        </p>
        <button style="font-size: 0.9rem;"class="btn" onclick="enterApp()">Enter App</button>
        <footer style="margin-top:32px; font-size:0.8em; color:#888; text-align:center;">
            &copy; 2025 Lalisa Duguma, Global Evergreening Alliance (GEA). All rights reserved.
        </footer>
    </div>

    <!-- Main Application Container -->
    <div class="container" id="mainApp">
        <div class="header">
            <h1>Treestimator: Seedlings to Trees Estimator</h1>
            <p>Contextualized Project Level Seedling to Trees Modeling & Analysis Tool</p><br>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>Project Details</h3>
                <div class="input-row">
                    <label for="userName">Project Leader:</label>
                    <input type="text" id="userName" value="Karanja C.">
                </div>
                <div class="input-row">
                    <label for="projectLocation">Project Location:</label>
                    <input type="text" id="projectLocation" value="Kitui, Kenya">
                </div>
                <div class="input-row">
                    <label for="projectSize">Project Size (ha):</label>
                    <input type="number" id="projectSize" value="2500" min="0">
                </div>
        
                <div class="input-row">
                    <label for="projectYear">Planting Year:</label>
                    <input type="number" id="projectYear" value="2025" min="2000" max="2050">
                </div>
            </div>

            <div class="control-group">
                <h3>Planting Schedule (Seedlings)</h3>
                <div class="input-row">
                    <label>Year 1:</label>
                    <input type="number" id="year1" value="100000" min="0">
                </div>
                <div class="input-row">
                    <label>Year 2:</label>
                    <input type="number" id="year2" value="350000" min="0">
                </div>
                <div class="input-row">
                    <label>Year 3:</label>
                    <input type="number" id="year3" value="350000" min="0">
                </div>
                <div class="input-row">
                    <label>Year 4:</label>
                    <input type="number" id="year4" value="150000" min="0">
                </div>
                <div class="input-row">
                    <label>Year 5:</label>
                    <input type="number" id="year5" value="50000" min="0">
                </div>
            </div>

            <div class="control-group">
                <h3>Survival Rates (%)</h3>
                <div class="input-row">
                    <label>Year 1 (Age 1):</label>
                    <input type="number" id="survival1" value="70" step="0.1" min="0" max="100">
                </div>
                <div class="input-row">
                    <label>Year 2 (Age 2):</label>
                    <input type="number" id="survival2" value="85" step="0.1" min="0" max="100">
                </div>
                <div class="input-row">
                    <label>Year 3 (Age 3):</label>
                    <input type="number" id="survival3" value="98" step="0.1" min="0" max="100">
                </div>
                <div class="input-row">
                    <label>Year 4 (Age 4):</label>
                    <input type="number" id="survival4" value="98" step="0.1" min="0" max="100">
                </div>
                <div class="input-row">
                    <label>Year 5 (Age 5):</label>
                    <input type="number" id="survival5" value="98" step="0.1" min="0" max="100">
                </div>
                <div class="input-row">
                    <label>Year 6+ (Age 6+):</label>
                    <input type="number" id="survival6" value="99" step="0.1" min="0" max="100">
                </div>
            </div>

            <div class="control-group">
                <h3>Beating Up Settings</h3>
                <div class="input-row">
                    <label>Replace Mortality 12 Months after Planting:</label>
                    <input type="checkbox" id="beatYear1" checked>
                </div>
                <div class="input-row">
                    <label>Replace Mortality 24 Months after Planting:</label>
                    <input type="checkbox" id="beatYear2" checked>
                </div>
                <div class="input-row">
                    <label>Simulation Years:</label>
                    <input type="number" id="simYears" value="30" min="7" max="50">
                </div>
                <div class="input-row">
                    <label>Beating Up Stops (Project Year):</label>
                    <input type="number" id="beatUpStopYear" value="5" min="1" max="50">
                </div>
            </div>

            <div class="control-group">
                <h3>Thinning Regimes</h3>
                <div class="input-row">
                    <label>Number of Thinning Regimes:</label>
                    <input type="number" id="numThinningRegimes" value="0" min="0" max="10" onchange="updateThinningRegimes()">
                </div>
                <div id="thinningRegimes">
                    <!-- Thinning regimes will be dynamically added here -->
                </div>
            </div>
        </div>

        <div class="button-container">
            <button class="btn btn-primary" onclick="runSimulation()"> Run Simulation: Estimate My Trees</button>
        </div>

        <footer style="margin-top:32px; font-size:0.8em; color:#888; text-align:center;">
            &copy; 2025 Lalisa Duguma, Global Evergreening Alliance (GEA). All rights reserved.
        </footer>

        <hr style="border:0; border-top:2px solid #4CAF50; margin:24px 0 8px 0;">
        <div class="button-container">
            <span style="font-family:'Gill Sans', 'Gill Sans MT', Calibri, 'Trebuchet MS', sans-serif; font-weight:bold; font-size:2.1em; color:#1976D2; margin-right:16px; vertical-align:middle;">Your Simulation Results</span>
            <button class="btn btn-secondary" onclick="exportToPDF()" style="display:none; vertical-align:middle; font-size:0.95em; padding:4px 12px;" id="exportBtn">📄 Generate PDF Summary</button>
        </div>

        <div class="results" id="results">
            <div class="summary-cards" id="summaryCards">
                <!-- Summary cards will be populated here -->
            </div>

            <div class="charts-container">
                <div class="chart-wrapper">
                    <h3>Total Live Trees Over Time</h3>
                    <canvas id="survivalChart"></canvas>
                </div>
                <div class="chart-wrapper">
                    <h3>Survivors from Main Planting by Planting Year</h3>
                    <canvas id="cumulativeChart"></canvas>
                </div>
            </div>

            <div class="detailed-table">
                <h3>Detailed Year-by-Year Analysis</h3>
                <div style="overflow-x: auto;">
                    <table id="detailedTable">
                        <!-- Table will be populated here -->
                    </table>
                </div>
            </div>

            <div class="methodology">
                <h3>🧮 Methodological Overview</h3>
                <p><strong>This simulation employs a cohort-based survival model with the following key principles:</strong></p>
                <ul>
                    <li><strong>Cohort Tracking:</strong> Each year's plantings (main planting and beat-up replacements) are tracked as separate cohorts throughout their lifecycle.</li>
                    <li><strong>Cumulative Survival:</strong> Trees must survive each year's mortality rate to continue to the next year.</li>
                    <li id="beatingUpStrategy"></li> 
                    <li><strong>Beating Up Cutoff:</strong> All beating up activities stop at the user-defined calendar year. This means no new replacement seedlings are planted from the subsequent calendar year onwards, regardless of tree age.</li>
                    <li id="methodologySurvivalRates"><strong>Age-Based Mortality:</strong> Survival rates are defined by user input: Age 1 (N/A%), Age 2 (N/A%), Age 3 (N/A%), Age 4 (N/A%), Age 5 (N/A%), Age 6+ (N/A%).</li>
                    <li id="thinningMethodology"><strong>Thinning Operations:</strong> No thinning regimes defined.</li>
                    <li><strong>Mathematical Model:</strong> Survivors(end of year) = Survivors(start of year) × Survival Rate(age) × (1 - Thinning Rate if applicable)</li>
                </ul><br>
                <p><strong>Key Assumptions</strong></p>
                <ul>
                    <li>Beating up only replaces deaths from trees that completed Age 1 or Age 2.</li>
                    <li>Replacement seedlings are planted at the beginning of rainy season in the subsequent calendar year and follow the same survival pattern as main plantings.</li>
                    <li>No beating up occurs from the calendar year after the user-defined cutoff onwards.</li>
                    <li>Thinning is applied to all cohorts of the specified age at the end of each calendar year, before natural mortality.</li>
                    <li>Thinned trees are removed and do not contribute to future survival or beating up calculations.</li>
                    <li>No natural regeneration or additional mortality factors beyond the defined survival rates are considered.</li>
                    <li>Survival rates remain constant within each specified age category.</li>
                </ul><br>

                <p><strong>Disclaimer</strong></p>
                <ul>
                    <p>This app is provided for estimation purposes only. While best effort was made to ensure accuracy, results may vary and should not be considered definitive. Always consult with a qualified professional for critical decisions.</p>
                    <p>The Developer or GEA is not liable for any damages due to the use of this product. </p>
                </ul><br>

                <p><strong>Developer</strong></p>
                <ul>
                    <p>Lalisa Duguma, PhD</p>
                    <p>Global Evergreening Alliance (GEA) (2025) </p>
                </ul><br>
            </div>
        </div>
    </div>

    <script>
        // Function to show the main app and hide the landing page
        function enterApp() {
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            // Adjust body styling for the main app
            document.body.style.alignItems = 'flex-start';
            document.body.style.padding = '20px';
        }

        // Ensure Chart.js and its annotation plugin are registered
        const { Chart } = window;
        if (Chart && typeof ChartjsAnnotation !== 'undefined') {
            Chart.register(ChartjsAnnotation);
        } else {
            console.warn("Chart.js or ChartjsAnnotation plugin not found. Charts and annotations might not work.");
        }

        let simulationData = null; // Stores the results of the last simulation
        let charts = {}; // Stores Chart.js instances for easy destruction

        /**
         * Updates the thinning regimes input section based on the number specified
         */
        function updateThinningRegimes() {
            const numRegimes = parseInt(document.getElementById('numThinningRegimes').value) || 0;
            const container = document.getElementById('thinningRegimes');
            
            // Clear existing regimes
            container.innerHTML = '';
            
            // Add input fields for each regime
            for (let i = 1; i <= numRegimes; i++) {
                const regimeDiv = document.createElement('div');
                regimeDiv.className = 'thinning-regime';
                regimeDiv.innerHTML = `
                    <h4>Thinning Regime ${i}</h4>
                    <div class="input-row">
                        <label>Thinning Age (years):</label>
                        <input type="number" id="thinningAge${i}" value="${5 + (i * 5)}" min="1" max="50">
                    </div>
                    <div class="input-row">
                        <label>Trees Removed (%):</label>
                        <input type="number" id="thinningPercent${i}" value="30" min="0" max="100" step="0.1">
                    </div>
                `;
                container.appendChild(regimeDiv);
            }
        }

        /**
         * Gets thinning regimes from user input
         * @returns {Array} Array of thinning regime objects
         */
        function getThinningRegimes() {
            const numRegimes = parseInt(document.getElementById('numThinningRegimes').value) || 0;
            const regimes = [];
            
            for (let i = 1; i <= numRegimes; i++) {
                const age = parseInt(document.getElementById(`thinningAge${i}`).value);
                const percent = parseFloat(document.getElementById(`thinningPercent${i}`).value);
                
                if (!isNaN(age) && !isNaN(percent) && age > 0 && percent >= 0 && percent <= 100) {
                    regimes.push({
                        age: age,
                        removalRate: percent / 100
                    });
                }
            }
            
            // Sort regimes by age
            regimes.sort((a, b) => a.age - b.age);
            
            return regimes;
        }

        /**
         * Runs the tree planting simulation based on user inputs.
         * Fetches input values, performs the simulation, and displays the results.
         */
        function runSimulation() {
            // Get input values from the UI
            const plantingSchedule = {
                1: parseInt(document.getElementById('year1').value),
                2: parseInt(document.getElementById('year2').value),
                3: parseInt(document.getElementById('year3').value),
                4: parseInt(document.getElementById('year4').value),
                5: parseInt(document.getElementById('year5').value)
            };

            const survivalRates = {
                year1: parseFloat(document.getElementById('survival1').value) / 100,
                year2: parseFloat(document.getElementById('survival2').value) / 100,
                year3: parseFloat(document.getElementById('survival3').value) / 100,
                year4: parseFloat(document.getElementById('survival4').value) / 100,
                year5: parseFloat(document.getElementById('survival5').value) / 100,
                year6plus: parseFloat(document.getElementById('survival6').value) / 100
            };

            const beatUpSettings = {
                year1: document.getElementById('beatYear1').checked,
                year2: document.getElementById('beatYear2').checked
            };

            const beatUpStopYear = parseInt(document.getElementById('beatUpStopYear').value);
            const totalYears = parseInt(document.getElementById('simYears').value);
            const thinningRegimes = getThinningRegimes();

            // Validate inputs
            for (let i = 1; i <= 5; i++) {
                if (isNaN(plantingSchedule[i]) || plantingSchedule[i] < 0) {
                    showMessageBox(`Please enter a valid non-negative number for Year ${i} plantings.`);
                    return;
                }
            }
            if (isNaN(survivalRates.year1) || survivalRates.year1 < 0 || survivalRates.year1 > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 1.'); return;
            }
            if (isNaN(survivalRates.year2) || survivalRates.year2 < 0 || survivalRates.year2 > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 2.'); return;
            }
            if (isNaN(survivalRates.year3) || survivalRates.year3 < 0 || survivalRates.year3 > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 3.'); return;
            }
            if (isNaN(survivalRates.year4) || survivalRates.year4 < 0 || survivalRates.year4 > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 4.'); return;
            }
            if (isNaN(survivalRates.year5) || survivalRates.year5 < 0 || survivalRates.year5 > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 5.'); return;
            }
            if (isNaN(survivalRates.year6plus) || survivalRates.year6plus < 0 || survivalRates.year6plus > 1) {
                showMessageBox('Please enter a valid survival rate (0-100) for Year 6+.'); return;
            }
            if (isNaN(totalYears) || totalYears < 7 || totalYears > 50) {
                showMessageBox('Please enter a valid number of simulation years (between 7 and 50).');
                return;
            }
            if (isNaN(beatUpStopYear) || beatUpStopYear < 1 || beatUpStopYear > totalYears) {
                showMessageBox(`Please enter a valid year for "Beating Up Stops" (between 1 and ${totalYears}).`);
                return;
            }

            // Validate thinning regimes
            for (let i = 0; i < thinningRegimes.length; i++) {
                const regime = thinningRegimes[i];
                if (regime.age > totalYears) {
                    showMessageBox(`Thinning age ${regime.age} cannot be greater than simulation years (${totalYears}).`);
                    return;
                }
            }

            // Perform the simulation
            simulationData = performSimulation(plantingSchedule, survivalRates, beatUpSettings, totalYears, beatUpStopYear, thinningRegimes);

            // Display results in the UI
            displayResults(simulationData);
            
            // Show the export button
            document.getElementById('exportBtn').style.display = 'inline-block';
        }

        /**
         * Core simulation logic. Tracks cohorts and their survival over time,
         * incorporating main plantings, beat-up replacements, and thinning operations.
         * @param {Object} plantingSchedule - Initial planting counts per year (1-5).
         * @param {Object} survivalRates - Survival rates for different age groups.
         * @param {Object} beatUpSettings - Flags for enabling Year 1 and Year 2 beat-up.
         * @param {number} totalYears - Total simulation years.
         * @param {number} beatUpCutoffYear - The calendar year when beating up stops.
         * @param {Array} thinningRegimes - Array of thinning regime objects.
         * @returns {Object} - Comprehensive simulation results.
         */
        function performSimulation(plantingSchedule, survivalRates, beatUpSettings, totalYears, beatUpCutoffYear, thinningRegimes) {
            // Stores all active cohorts. Each cohort tracks its planting year, original source, and current survivors.
            const activeCohorts = [];
            // Stores detailed results for each calendar year of the simulation.
            const yearlySimulationResults = [];
            // Track total trees removed by thinning
            let totalTreesThinned = 0;

            // Accumulates deaths from the current year that will trigger beat-up plantings in the *next* year.
            // Stores objects like { originalPlantYear: number, deaths: number, age: number }
            let deathsToReplaceNextYear = [];

            for (let currentCalendarYear = 1; currentCalendarYear <= totalYears; currentCalendarYear++) {
                let newPlantingsThisYear = 0; // Total new seedlings planted in this calendar year (main planting + beat-up)
                let totalDeathsThisYear = 0; // Total deaths across all cohorts in this calendar year
                let totalSurvivorsEndOfYear = 0; // Total live trees at the end of this calendar year
                let beatUpPlantingsThisYear = 0; // Total beat-up seedlings planted in this calendar year
                let totalThinnedThisYear = 0; // Total trees thinned in this calendar year
                const cohortDetailsForCurrentYear = []; // Detailed breakdown of each cohort for the table

                // 1. Add new main plantings for the current calendar year (only for Years 1-5)
                if (currentCalendarYear <= 5 && plantingSchedule[currentCalendarYear] > 0) {
                    const count = plantingSchedule[currentCalendarYear];
                    activeCohorts.push({
                        id: `P${currentCalendarYear}`, // Unique ID for main planting cohort
                        plantCalendarYear: currentCalendarYear, // The calendar year this specific cohort was planted
                        originalPlantYear: currentCalendarYear, // The main planting year this cohort is associated with
                        currentSurvivors: count // Number of trees alive from this cohort
                    });
                    newPlantingsThisYear += count;
                }

                // 2. Add beat-up plantings from previous year's accumulated deaths
                // These replacements are planted at the *start* of the currentCalendarYear.
                // Beat-up replacements occur from Project Year 2 up to beatUpCutoffYear.
                if (currentCalendarYear > 1 && currentCalendarYear <= beatUpCutoffYear) {
                    deathsToReplaceNextYear.forEach(item => {
                        const count = item.deaths;
                        if (count > 0) {
                            activeCohorts.push({
                                id: `B${item.age}fromP${item.originalPlantYear}-CY${currentCalendarYear-1}`, // Unique ID for beat-up cohort
                                plantCalendarYear: currentCalendarYear, // The calendar year this beat-up cohort is planted
                                originalPlantYear: item.originalPlantYear, // The main planting year this beat-up cohort is replacing
                                currentSurvivors: count
                            });
                            newPlantingsThisYear += count;
                            beatUpPlantingsThisYear += count;
                        }
                    });
                }
                // Reset the deaths to replace for the next iteration
                deathsToReplaceNextYear = [];

                // 3. Process survival and thinning for all active cohorts (including newly added ones at the start of this year)
                const cohortsToProcess = [...activeCohorts];
                activeCohorts.length = 0; // Clear the array to repopulate with surviving cohorts

                cohortsToProcess.forEach(cohort => {
                    if (cohort.currentSurvivors <= 0) {
                        return; // This cohort has already died out, skip
                    }

                    // Calculate the age of the trees in this cohort at the end of the current calendar year
                    const ageOfCohort = currentCalendarYear - cohort.plantCalendarYear + 1;

                    let startingCountForCohort = cohort.currentSurvivors;
                    let survivorsAfterThinning = startingCountForCohort;
                    let thinnedFromCohort = 0;

                    // Apply thinning first (before natural mortality)
                    const applicableThinning = thinningRegimes.find(regime => regime.age === ageOfCohort);
                    if (applicableThinning) {
                        thinnedFromCohort = Math.floor(startingCountForCohort * applicableThinning.removalRate);
                        survivorsAfterThinning = startingCountForCohort - thinnedFromCohort;
                        totalThinnedThisYear += thinnedFromCohort;
                        totalTreesThinned += thinnedFromCohort;
                    }

                    // Determine the appropriate survival rate based on age
                    let survivalRate;
                    if (ageOfCohort === 1) {
                        survivalRate = survivalRates.year1;
                    } else if (ageOfCohort === 2) {
                        survivalRate = survivalRates.year2;
                    } else if (ageOfCohort === 3) {
                        survivalRate = survivalRates.year3;
                    } else if (ageOfCohort === 4) {
                        survivalRate = survivalRates.year4;
                    } else if (ageOfCohort === 5) {
                        survivalRate = survivalRates.year5;
                    } else { // age >= 6
                        survivalRate = survivalRates.year6plus;
                    }

                    // Apply natural mortality to the trees remaining after thinning
                    const deathsInCohort = Math.floor(survivorsAfterThinning * (1 - survivalRate));
                    const finalSurvivorsInCohort = survivorsAfterThinning - deathsInCohort;

                    totalDeathsThisYear += deathsInCohort;
                    totalSurvivorsEndOfYear += finalSurvivorsInCohort;

                    // If there are survivors, update the cohort and add it back to the active list for the next year
                    if (finalSurvivorsInCohort > 0) {
                        cohort.currentSurvivors = finalSurvivorsInCohort;
                        activeCohorts.push(cohort);
                    }

                    // Accumulate deaths for potential beat-up in the *next* calendar year
                    // Only collect deaths if beat-up is allowed in the *next* year (i.e., currentCalendarYear < beatUpCutoffYear)
                    if (currentCalendarYear < beatUpCutoffYear) {
                        if (ageOfCohort === 1 && beatUpSettings.year1) {
                            deathsToReplaceNextYear.push({
                                originalPlantYear: cohort.originalPlantYear,
                                deaths: deathsInCohort,
                                age: 1
                            });
                        } else if (ageOfCohort === 2 && beatUpSettings.year2) {
                            deathsToReplaceNextYear.push({
                                originalPlantYear: cohort.originalPlantYear,
                                deaths: deathsInCohort,
                                age: 2
                            });
                        }
                    }

                    // Store detailed info for this cohort for the current year's table
                    cohortDetailsForCurrentYear.push({
                        cohortId: cohort.id,
                        plantYear: cohort.plantCalendarYear,
                        originalPlantYear: cohort.originalPlantYear,
                        age: ageOfCohort,
                        startCount: startingCountForCohort,
                        thinned: thinnedFromCohort,
                        afterThinning: survivorsAfterThinning,
                        survivalRate: survivalRate,
                        deaths: deathsInCohort,
                        endCount: finalSurvivorsInCohort
                    });
                });

                // Store the aggregated results for the current calendar year
                yearlySimulationResults.push({
                    year: currentCalendarYear,
                    newPlantings: newPlantingsThisYear,
                    totalDeaths: totalDeathsThisYear,
                    totalBeatUp: beatUpPlantingsThisYear,
                    totalThinned: totalThinnedThisYear,
                    totalSurvivorsEndOfYear: totalSurvivorsEndOfYear,
                    cohortDetails: cohortDetailsForCurrentYear
                });
            }

            // Calculate summary statistics
            const totalOriginalPlanted = Object.values(plantingSchedule).reduce((sum, val) => sum + val, 0);
            const totalBeatUpOverall = yearlySimulationResults.reduce((sum, yr) => sum + yr.totalBeatUp, 0);
            const finalSurvivors = yearlySimulationResults[totalYears - 1]?.totalSurvivorsEndOfYear || 0;
            // Get survivors at the user-defined beat-up cutoff year
            const survivorsAtCutoffYear = yearlySimulationResults[beatUpCutoffYear - 1]?.totalSurvivorsEndOfYear || 0;

            // Prepare data for the "Estimated Total Live Trees Over Time" chart
            const yearlyTotalsChartData = {};
            yearlySimulationResults.forEach(yearData => {
                yearlyTotalsChartData[yearData.year] = yearData.totalSurvivorsEndOfYear;
            });

            // Prepare data for the "Survivors by main planting Year" chart
            // This will track the total number of trees alive at the end of each year
            // that originated from a specific initial planting year (including their replacements).
            const cumulativeByOriginalPlantingYear = {};
            for (let i = 1; i <= 5; i++) {
                cumulativeByOriginalPlantingYear[i] = new Array(totalYears).fill(0);
            }

            yearlySimulationResults.forEach(yearData => {
                yearData.cohortDetails.forEach(detail => {
                    const originalPlantYear = detail.originalPlantYear;
                    const index = yearData.year - 1; // Array index corresponds to calendar year - 1

                    if (cumulativeByOriginalPlantingYear[originalPlantYear] !== undefined) {
                        cumulativeByOriginalPlantingYear[originalPlantYear][index] += detail.endCount;
                    }
                });
            });

            return {
                yearlySimulationResults: yearlySimulationResults,
                totalYears: totalYears,
                totalOriginalPlanted: totalOriginalPlanted,
                totalBeatUpOverall: totalBeatUpOverall,
                totalTreesThinned: totalTreesThinned,
                finalSurvivors: finalSurvivors,
                survivorsAtCutoffYear: survivorsAtCutoffYear,
                yearlyTotalsChartData: yearlyTotalsChartData,
                cumulativeByOriginalPlantingYear: cumulativeByOriginalPlantingYear,
                beatUpCutoffYear: beatUpCutoffYear,
                survivalRates: survivalRates,
                thinningRegimes: thinningRegimes
            };
        }

        /**
         * Displays the simulation results in the UI, including summary cards,
         * detailed table, and charts.
         * @param {Object} data - The simulation results object.
         */
        function displayResults(data) {
            // Make the results section visible and scroll to it
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });

            // Populate summary cards
            displaySummaryCards(data);

            // Populate detailed table
            displayDetailedTable(data);

            // Create and update charts
            createCharts(data);

            // Update methodology section on the HTML page
            updateMethodologySurvivalRates(data.survivalRates);
            updateThinningMethodology(data.thinningRegimes);
        }

        function updateBeatingUpStrategyMessage() {
            // These lines correctly read the current state of the actual checkboxes in the HTML
            const beatYear1Checked = document.getElementById('beatYear1').checked;
            const beatYear2Checked = document.getElementById('beatYear2').checked;
            const beatingUpStrategyElement = document.getElementById('beatingUpStrategy');

            let message = "Beating Up Strategy: ";

            if (beatYear1Checked && beatYear2Checked) {
                // Scenario: Both beatYear1 and beatYear2 are selected
                message += "Seedlings that die at the end of their first year (Age 1) are replaced in the following calendar year. Similarly, those that die at the end of their second year (Age 2) are replaced in the following calendar year. Beating up happens for both first-year and second-year mortality.";
            } else if (beatYear1Checked && !beatYear2Checked) {
                // Scenario: Only beatYear1 is checked
                message += "Seedlings that die at the end of their first year (Age 1) are replaced in the following calendar year. Beating up is only performed for first-year mortality.";
            } else {
                // Scenario: Neither are checked, or only beatYear2 is checked
                message += "No beating up is applied based on current selections.";
            }

            beatingUpStrategyElement.innerHTML = message;
        }

        // Add event listeners to the checkboxes so the message updates when they are changed
        document.getElementById('beatYear1').addEventListener('change', updateBeatingUpStrategyMessage);
        document.getElementById('beatYear2').addEventListener('change', updateBeatingUpStrategyMessage);

        // Call the function once when the page loads to set the initial message based on default checkbox states
        document.addEventListener('DOMContentLoaded', updateBeatingUpStrategyMessage);
        
        /**
         * Updates the survival rates in the methodology section on the HTML page.
         * @param {Object} survivalRates - The survival rates object from simulationData.
         */

        function getBeatingUpStrategyMessage() { // Renamed for clarity, or you can keep original name and add a parameter
            const beatYear1Checked = document.getElementById('beatYear1').checked; // Ensure these IDs are correct as per our last discussion
            const beatYear2Checked = document.getElementById('beatYear2').checked; // Ensure these IDs are correct

            let message = "Beating Up Strategy: "; // This is for HTML display

            if (beatYear1Checked && beatYear2Checked) {
                message += "Seedlings that die at the end of their first year (Age 1) are replaced in the following calendar year. Similarly, those that die at the end of their second year (Age 2) are replaced in the following calendar year. Beating up happens for both first-year and second-year mortality.";
            } else if (beatYear1Checked && !beatYear2Checked) {
                message += "Seedlings that die at the end of their first year (Age 1) are replaced in the following calendar year. Beating up is only performed for first-year mortality.";
            } else {
                message += "No beating up is applied based on current selections.";
            }
            return message; // Return the generated HTML string
        }

        // And the function that updates the DOM element would use this
        function updateBeatingUpStrategyMessageUI() {
            const beatingUpStrategyElement = document.getElementById('beatingUpStrategy');
            beatingUpStrategyElement.innerHTML = getBeatingUpStrategyMessage();
        }

        // Update your event listeners to call the new UI update function
        document.getElementById('beatYear1').addEventListener('change', updateBeatingUpStrategyMessageUI);
        document.getElementById('beatYear2').addEventListener('change', updateBeatingUpStrategyMessageUI);

        // Call the UI update function once when the page loads
        document.addEventListener('DOMContentLoaded', updateBeatingUpStrategyMessageUI); 
         
        function updateMethodologySurvivalRates(survivalRates) {
            const s1 = (survivalRates.year1 * 100).toFixed(1);
            const s2 = (survivalRates.year2 * 100).toFixed(1);
            const s3 = (survivalRates.year3 * 100).toFixed(1);
            const s4 = (survivalRates.year4 * 100).toFixed(1);
            const s5 = (survivalRates.year5 * 100).toFixed(1);
            const s6plus = (survivalRates.year6plus * 100).toFixed(1);

            const methodologyText = `
                <strong>Age-Based Mortality:</strong> Survival rates are defined by user input: 
                Age 1 (${s1}%), 
                Age 2 (${s2}%), 
                Age 3 (${s3}%), 
                Age 4 (${s4}%), 
                Age 5 (${s5}%), 
                Age 6+ (${s6plus}%).
            `;
            document.getElementById('methodologySurvivalRates').innerHTML = methodologyText;
        }

        /**
         * Updates the thinning methodology in the methodology section
         * @param {Array} thinningRegimes - Array of thinning regime objects
         */
        function updateThinningMethodology(thinningRegimes) {
            const thinningElement = document.getElementById('thinningMethodology');
            
            if (thinningRegimes.length === 0) {
                thinningElement.innerHTML = '<strong>Thinning Operations:</strong> No thinning regimes defined.';
            } else {
                let thinningText = '<strong>Thinning Operations:</strong> ';
                const regimeDescriptions = thinningRegimes.map(regime => 
                    `Age ${regime.age} (${(regime.removalRate * 100).toFixed(1)}% removal)`
                );
                thinningText += regimeDescriptions.join(', ') + '. Thinning is applied before natural mortality at the end of each calendar year.';
                thinningElement.innerHTML = thinningText;
            }
        }

        /**
         * Populates the summary cards with key simulation metrics.
         * @param {Object} data - The simulation results object.
         */
        function displaySummaryCards(data) {
            const totalPlanted = data.totalOriginalPlanted;
            const yearCutoffSurvivors = data.survivorsAtCutoffYear; 
            const finalSurvivors = data.finalSurvivors;
            const totalBeatUp = data.totalBeatUpOverall;
            const totalThinned = data.totalTreesThinned;

            const finalSurvivalRate = totalPlanted > 0 ? ((finalSurvivors / (totalPlanted+totalBeatUp)) * 100).toFixed(1) : '0.0';
            const yearCutoffSurvivalRate = totalPlanted > 0 ? ((yearCutoffSurvivors / totalPlanted) * 100).toFixed(1) : '0.0';

            const summaryHTML = `
                <div class="summary-card">
                    <h4>Total Original Planting</h4>
                    <div class="value">${totalPlanted.toLocaleString()}</div>
                    <p>Planned Main Planting (Years 1-5)</p>
                </div>
                <div class="summary-card">
                    <h4>Trees at Year ${data.beatUpCutoffYear}</h4>
                    <div class="value">${yearCutoffSurvivors.toLocaleString()}</div>
                    <p>${yearCutoffSurvivalRate}% of Planned Main Plantings</p>
                </div>
                <div class="summary-card">
                    <h4>Trees at Year ${data.totalYears}</h4>
                    <div class="value">${finalSurvivors.toLocaleString()}</div>
                    <p>${finalSurvivalRate}% final survival rate</p>
                </div>
                <div class="summary-card">
                    <h4>Total Beat-up Replacements</h4>
                    <div class="value">${totalBeatUp.toLocaleString()}</div>
                    <p>Seedlings planted (until Year ${data.beatUpCutoffYear})</p>
                </div>
                <div class="summary-card">
                    <h4>Total Trees Thinned</h4>
                    <div class="value">${totalThinned.toLocaleString()}</div>
                    <p>Trees removed by thinning operations</p>
                </div>
            `;
            document.getElementById('summaryCards').innerHTML = summaryHTML;
        }

        /**
         * Populates the detailed year-by-year analysis table.
         * @param {Object} data - The simulation results object.
         */
        function displayDetailedTable(data) {
            let tableHTML = `
                <thead>
                    <tr>
                        <th>Year</th>
                        <th>New Plantings</th>
                        <th>Total Mortality</th>
                        <th>Trees Thinned</th>
                        <th>Beat-up Replacements</th>
                        <th>Total Survivors (E.O.Y)</th>
                        <th>Beat-up Active</th>
                    </tr>
                </thead>
                <tbody>
            `;

            data.yearlySimulationResults.forEach(yearData => {
                const beatUpActive = yearData.year <= data.beatUpCutoffYear ? "Yes" : "No";
                
                tableHTML += `
                    <tr>
                        <td><strong>Year ${yearData.year}</strong></td>
                        <td>${yearData.newPlantings.toLocaleString()}</td>
                        <td>${yearData.totalDeaths.toLocaleString()}</td>
                        <td>${yearData.totalThinned.toLocaleString()}</td>
                        <td>${yearData.totalBeatUp.toLocaleString()}</td>
                        <td><strong>${yearData.totalSurvivorsEndOfYear.toLocaleString()}</strong></td>
                        <td>${beatUpActive}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody>';
            document.getElementById('detailedTable').innerHTML = tableHTML;
        }

        /**
         * Creates or updates the Chart.js graphs.
         * @param {Object} data - The simulation results object.
         */
        function createCharts(data) {
            // Destroy existing chart instances to prevent memory leaks and redraw issues
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            // Chart 1: Total Live Trees Over Time
            const ctx1 = document.getElementById('survivalChart').getContext('2d');
            
            // Create annotations for thinning events
            const thinningAnnotations = {};
            data.thinningRegimes.forEach((regime, index) => {
                thinningAnnotations[`thinning${index}`] = {
                    type: 'line',
                    xMin: regime.age,
                    xMax: regime.age,
                    borderColor: '#ff9800',
                    borderWidth: 2,
                    borderDash: [3, 3],
                    label: {
                        content: `Thinning at Age ${regime.age}`,
                        enabled: true,
                        position: 'top',
                        color: '#ff9800',
                        font: {
                            size: 10,
                            weight: 'normal'
                        },
                        backgroundColor: 'rgba(255, 255, 255, 0.8)',
                        padding: 4,
                        borderRadius: 4
                    }
                };
            });

            // Add beat-up cutoff annotation
            thinningAnnotations.beatupCutoff = {
                type: 'line',
                xMin: data.beatUpCutoffYear,
                xMax: data.beatUpCutoffYear,
                borderColor: 'red',
                borderWidth: 2,
                borderDash: [5, 5],
                label: {
                    content: `Beating up Stops (Year ${data.beatUpCutoffYear})`,
                    enabled: true,
                    position: 'top',
                    color: 'red',
                    font: {
                        fontFamily: 'Helvetica, Arial, sans-serif',
                        size: 12,
                        weight: 'normal'
                    },
                    backgroundColor: 'rgba(255, 255, 255, 0.8)',
                    padding: 6,
                    borderRadius: 6
                }
            };

            charts.survival = new Chart(ctx1, {
                type: 'line',
                data: {
                    labels: Object.keys(data.yearlyTotalsChartData),
                    datasets: [{
                        label: 'Total Live Trees at End of Year',
                        data: Object.values(data.yearlyTotalsChartData),
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        annotation: {
                            annotations: thinningAnnotations
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Project Year'
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                callback: function(value, index, ticks) {
                                    return index % 2 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Live Trees'
                            },
                            beginAtZero: true,
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            // Chart 2: Survivors by main planting Year
            const ctx2 = document.getElementById('cumulativeChart').getContext('2d');
            const colors = ['#1565C0', '#388E3C', '#FBC02D', '#D32F2F', '#7B1FA2'];
            const cumulativeDatasets = [];

            for (let i = 1; i <= 5; i++) {
                if (data.cumulativeByOriginalPlantingYear[i]) {
                    cumulativeDatasets.push({
                        label: `Main Planting Yr ${i}`,
                        data: data.cumulativeByOriginalPlantingYear[i],
                        borderColor: colors[i - 1],
                        backgroundColor: colors[i - 1].replace(')', ', 0.1)'),
                        borderWidth: 2,
                        fill: false,
                        tension: 0.4
                    });
                }
            }

            charts.cumulative = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: Object.keys(data.yearlyTotalsChartData),
                    datasets: cumulativeDatasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Project Year'
                            },
                            ticks: {
                                maxRotation: 0,
                                minRotation: 0,
                                callback: function(value, index, ticks) {
                                    return index % 2 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Number of Live Trees'
                            },
                            beginAtZero: true,
                            ticks: {
                                maxRotation: 0, 
                                minRotation: 0,
                                callback: function(value) {
                                    return value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }
        
        /**
         * Exports the simulation results to a PDF document.
         * Uses jsPDF and jsPDF-AutoTable for structured output.
         */
        function exportToPDF() {
            // Ensure simulation data exists before proceeding
            if (!simulationData) {
                showMessageBox('Please run the simulation first to generate data for export!');
                return;
            }

            // Retrieve values from the HTML input fields
            const userName = document.getElementById('userName').value;
            const projectLocation = document.getElementById('projectLocation').value;
            const projectSize = parseFloat(document.getElementById('projectSize').value);

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // --- Header ---
            doc.setFontSize(18);
            doc.setTextColor(46, 125, 50);
            doc.text("Treestimator Tool Report: Estimating Surviving Trees", 10, 20);
    
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text("This report is generated by the Treestimator (beta) tool on " + new Date().toLocaleDateString(), 10, 40);
            let y = 45;

            // --- Project Details Section ---
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 7;

            doc.setFontSize(10);
            doc.setTextColor(46, 125, 50);
            doc.text(`Dear ${userName},`, 10, y +=7);
            doc.text("Your project details and analysis results are presented below. Read the results and assumptions carefully.", 10, y += 7);
            doc.text("Thank you for using our tool. We are counting on you to nurture the seedlings so they thrive and become trees.", 10, y += 7);
            doc.text("The developer", 10, y += 7);

            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 15;

            doc.setFontSize(16);
            doc.setTextColor(46, 125, 50);
            doc.text("Project Details", 10, y);
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Project Leader: ${userName}`, 10, y += 8);
            doc.text(`Project land area (ha): ${projectSize.toLocaleString()}`, 10, y += 8);
            doc.text(`Project Location: ${projectLocation.toLocaleString()}`, 10, y += 8);
            doc.text(`Total Years of Simulation: ${simulationData.totalYears}`, 10, y += 8);
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            // --- Summary Section ---
            y += 15;
            doc.setFontSize(16);
            doc.setTextColor(46, 125, 50);
            doc.text("Tree Simulation Summary", 10, y);
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            // --- Survival details
            const s1 = (simulationData.survivalRates.year1 * 100).toFixed(1);
            const s2 = (simulationData.survivalRates.year2 * 100).toFixed(1);
            const s3 = (simulationData.survivalRates.year3 * 100).toFixed(1);
            const s4 = (simulationData.survivalRates.year4 * 100).toFixed(1);
            const s5 = (simulationData.survivalRates.year5 * 100).toFixed(1);
            const s6plus = (simulationData.survivalRates.year6plus * 100).toFixed(1);
            
            const leftMargin = 10;
            const rightMargin = 10;
            const textMaxWidth = doc.internal.pageSize.width - leftMargin - rightMargin;
            const lineHeight = doc.internal.getLineHeight() / doc.internal.scaleFactor;
            const longSurvivalRatesText = `Survival rates by age: Age 1 (${s1}%), Age 2 (${s2}%), Age 3 (${s3}%), Age 4 (${s4}%), Age 5 (${s5}%), Age 6+ (${s6plus}%).`;
            const wrappedSurvivalRates = doc.splitTextToSize(longSurvivalRatesText, textMaxWidth);

            doc.setFontSize(12);
            doc.setTextColor(0, 0, 0);
            doc.text(`Total Main Planting: ${simulationData.totalOriginalPlanted.toLocaleString()}`, 10, y += 8);
            doc.text(`Trees at Year ${simulationData.beatUpCutoffYear}: ${simulationData.survivorsAtCutoffYear.toLocaleString()} (${((simulationData.survivorsAtCutoffYear / simulationData.totalOriginalPlanted ) * 100).toFixed(1)}% of planned main plantings)`, 10, y += 7);
            doc.text(`Trees at Year ${simulationData.beatUpCutoffYear}: ${simulationData.survivorsAtCutoffYear.toLocaleString()} (${((simulationData.survivorsAtCutoffYear / (simulationData.totalOriginalPlanted + simulationData.totalBeatUpOverall)) * 100).toFixed(1)}% of all plantings)`, 10, y += 7);
            doc.text(`Trees at Year ${simulationData.totalYears}: ${simulationData.finalSurvivors.toLocaleString()} (${((simulationData.finalSurvivors / (simulationData.totalOriginalPlanted + simulationData.totalBeatUpOverall)) * 100).toFixed(1)}% final survival rate)`, 10, y += 7);
            doc.text(`Total Beat-up Replacements: ${simulationData.totalBeatUpOverall.toLocaleString()} (until Year ${simulationData.beatUpCutoffYear})`, 10, y += 7);
            doc.text(`Total Trees Thinned: ${simulationData.totalTreesThinned.toLocaleString()}`, 10, y += 7);
            
            wrappedSurvivalRates.forEach((line, index) => {
                doc.text(line, 10, y += lineHeight);
            });

            // Add thinning information if applicable
            if (simulationData.thinningRegimes.length > 0) {
                y += 7;
                const thinningText = `Thinning regimes: ${simulationData.thinningRegimes.map(r => `Age ${r.age} (${(r.removalRate * 100).toFixed(1)}% removal)`).join(', ')}.`;
                const wrappedThinningText = doc.splitTextToSize(thinningText, textMaxWidth);
                wrappedThinningText.forEach((line, index) => {
                    doc.text(line, 10, y += lineHeight);
                });
            }

            y += 10;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            // --- Detailed Table Section ---
            y += 7;
            doc.setFontSize(16);
            doc.setTextColor(46, 125, 50);
            doc.text("Detailed Year-by-Year Analysis", 10, y);
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 35;

            const tableColumn = ["Year", "Main Plantings", "Total Mortality", "Trees Thinned", "Beat-up Replacements", "Total Survivors (E.O.Y)", "Beat-up Active"];
            const tableRows = [];

            simulationData.yearlySimulationResults.forEach(yearData => {
                const beatUpActive = yearData.year <= simulationData.beatUpCutoffYear ? "Yes" : "No";
                tableRows.push([
                    `Year ${yearData.year}`,
                    yearData.newPlantings.toLocaleString(),
                    yearData.totalDeaths.toLocaleString(),
                    yearData.totalThinned.toLocaleString(),
                    yearData.totalBeatUp.toLocaleString(),
                    yearData.totalSurvivorsEndOfYear.toLocaleString(),
                    beatUpActive
                ]);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: y,
                theme: 'grid',
                styles: { fontSize: 7, cellPadding: 1.5, halign: 'center' },
                headStyles: { fillColor: [46, 125, 50], textColor: [255, 255, 255], fontStyle: 'bold' },
                alternateRowStyles: { fillColor: [248, 249, 250] },
            });

            // --- Add Methodology Section ---
            y = doc.autoTable.previous.finalY + 15;

            const pageHeight = doc.internal.pageSize.height;
            const bottomMargin = 20;
            if (y + 100 > pageHeight - bottomMargin) {
                doc.addPage();
                y = 20;
            }

            doc.setFontSize(16);
            doc.setTextColor(46, 125, 50);
            doc.text("Simulation Methodology", 10, y);
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            doc.setFontSize(10);
            doc.setTextColor(0, 0, 0);

            const dynamicBeatingUpStrategy = getBeatingUpStrategyMessage();

            const methodologyIntro = `This simulation employs a cohort-based survival model with the following key principles:`;
            const principles = [
                `• Cohort Tracking: Each year's plantings (main planting and beat-up replacements) are tracked as separate cohorts throughout their lifecycle.`,
                `• Cumulative Survival: Trees must survive each year's mortality rate to continue to the next year.`,
                `• ${dynamicBeatingUpStrategy}`,
                `• Beating Up Cutoff: All beating up activities stop at calendar Year ${simulationData.beatUpCutoffYear}. This means no new replacement seedlings are planted from calendar Year ${simulationData.beatUpCutoffYear + 1} onwards, regardless of tree age.`,
                `• Age-Based Mortality: Survival rates are specified as: Age 1 (${s1}%), Age 2 (${s2}%), Age 3 (${s3}%), Age 4 (${s4}%), Age 5 (${s5}%), Age 6+ (${s6plus}%).`,
                simulationData.thinningRegimes.length > 0 ? 
                    `• Thinning Operations: ${simulationData.thinningRegimes.map(r => `Age ${r.age} (${(r.removalRate * 100).toFixed(1)}% removal)`).join(', ')}. Thinning is applied before natural mortality.` :
                    `• Thinning Operations: No thinning regimes defined.`,
                `• Mathematical Model: Survivors(end_of_year) = (Survivors(start_of_year) - Thinned) × Survival Rate(age)`
            ];
            const assumptionsTitle = `Key Assumptions`;
            const assumptions = [
                `• Beating up only replaces deaths from trees that completed Age 1 or Age 2.`,
                `• Replacement seedlings are planted at the beginning of the subsequent calendar year and follow the same survival pattern as main plantings.`,
                `• No beating up occurs from the calendar year after the user-defined cutoff onwards.`,
                `• Thinning is applied to all cohorts of the specified age at the end of each calendar year, before natural mortality.`,
                `• Thinned trees are removed and do not contribute to future survival or beating up calculations.`,
                `• No natural regeneration or additional mortality factors beyond the defined survival rates are considered.`,
                `• Survival rates remain constant within each specified age category.`
            ];
            const conclusionTitle = `Note`;
            const conclusionText = `This model provides a simplified yet effective way to visualize the impact of seedling planting, management strategies, and thinning operations over time, allowing for better planning and resource allocation in restoration efforts.`;

            // Render methodology text
            y += 5;
            doc.text(doc.splitTextToSize(methodologyIntro, 180), 10, y);
            y += doc.splitTextToSize(methodologyIntro, 180).length * doc.getLineHeight() / doc.internal.scaleFactor + 5;

            principles.forEach(line => {
                doc.text(doc.splitTextToSize(line, 180), 10, y +=3);
                y += doc.splitTextToSize(line, 180).length * doc.getLineHeight() / doc.internal.scaleFactor;
            });

            y += 10;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(assumptionsTitle, 10, y);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            y += 7;

            assumptions.forEach(line => {
                doc.text(doc.splitTextToSize(line, 180), 10, y +=3);
                y += doc.splitTextToSize(line, 180).length * doc.getLineHeight() / doc.internal.scaleFactor;
            });

            y += 10;
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(conclusionTitle, 10, y);
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            y += 10;

            doc.text(doc.splitTextToSize(conclusionText, 180), 10, y);
            y += doc.splitTextToSize(conclusionText, 180).length * doc.getLineHeight() / doc.internal.scaleFactor + 10;
            y += 7;
            doc.setDrawColor(76, 175, 80);
            doc.line(10, y, 80, y);
            y += 5;

            doc.setFontSize(8);
            doc.setTextColor(100, 100, 100);
            doc.text("©2025 Lalisa Duguma, Global Evergreening Alliance (GEA). All rights reserved.", 10, y+= 5);
            doc.text("version: Beta", 10, y += 5);

            // Save the PDF
            const filenameLocation = projectLocation.replace(/ /g, '_');
            doc.save(`tree_planting_simulation_report_${filenameLocation}.pdf`);
        }

        /**
         * Custom message box function to replace alert().
         * Creates a simple modal-like message on the page.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
            overlay.style.display = 'flex';
            overlay.style.justifyContent = 'center';
            overlay.style.alignItems = 'center';
            overlay.style.zIndex = '1000';
            overlay.id = 'messageBoxOverlay';

            // Create message box
            const messageBox = document.createElement('div');
            messageBox.style.backgroundColor = 'white';
            messageBox.style.padding = '25px';
            messageBox.style.borderRadius = '15px';
            messageBox.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.3)';
            messageBox.style.textAlign = 'center';
            messageBox.style.maxWidth = '400px';
            messageBox.style.width = '90%';
            messageBox.style.fontFamily = 'Inter, sans-serif';
            messageBox.style.color = '#333';

            const messageText = document.createElement('p');
            messageText.textContent = message;
            messageText.style.marginBottom = '20px';
            messageText.style.fontSize = '1.1em';
            messageText.style.lineHeight = '1.5';

            const closeButton = document.createElement('button');
            closeButton.textContent = 'OK';
            closeButton.style.padding = '10px 25px';
            closeButton.style.fontSize = '1em';
            closeButton.style.fontWeight = '600';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '20px';
            closeButton.style.backgroundColor = '#4CAF50';
            closeButton.style.color = 'white';
            closeButton.style.cursor = 'pointer';
            closeButton.style.transition = 'background-color 0.3s ease';

            closeButton.onclick = () => {
                document.body.removeChild(overlay);
            };

            messageBox.appendChild(messageText);
            messageBox.appendChild(closeButton);
            overlay.appendChild(messageBox);
            document.body.appendChild(overlay);
        }
            
     </script>
</body>

</html>
